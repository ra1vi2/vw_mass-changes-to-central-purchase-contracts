/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/generic/app/navigation/service/NavigationHandler","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/ui/model/FilterOperator","ui/s2p/mm/cntrl/ctrmass/update/HeaderDistribution/model/formatter","sap/m/MessageBox","sap/ui/core/routing/History"],function(N,F,J,a,f,M,H){"use strict";this.oItemDistributionFilters=[];return sap.ui.controller("ui.s2p.mm.cntrl.ctrmass.update.HierItemDistribution.controller.HierItemDistribution",{formatter:f,onInit:function(){var t=this;var c=this.getOwnerComponent();var C=c.getComponentModel();C.setProperty("/View",this.getView());this.newData=[];this.changedContract=[];this.validationErrFields=[];this.updateContracts=[];this.getView().byId("HierItmDistTable").attachDataReceived(null,function(e){if(e&&e.getParameters()&&e.getParameters().getParameters()&&e.getParameters().getParameters().data&&e.getParameters().getParameters().data.results){var d=e.getParameters().getParameters().data.results.length;}if(d<=0){t.getView().byId("EditHierItmDist").setEnabled(false);}else{t.getView().byId("EditHierItmDist").setEnabled(true);}});},enableSimulationFeature:function(){this.getView().byId("SimulateBtn").setVisible(true);},ItemfilterBarSearch:function(e){var q,c;this.oItemDistributionFilters=[];var C=this.getOwnerComponent();var o=C.getComponentModel();var s=this.getView().byId("ItemSearchFld");q=s.getValue();if(e.getId()==="search"){q=e.getParameter("query");}if(q!==undefined&&q!==null&&q.length>0){c=new F({path:"FormattedPurchaseContractItem",operator:a.Contains,value1:q,bAnd:true});this.oItemDistributionFilters.push(c);o.setProperty("/searchFlag",true);}else{o.setProperty("/searchFlag",false);}this.getView().byId("HierItmDistTable").rebindTable();},handleItemFilters:function(){var s=this.getView().byId("HierItmDistTable");var c=this.getOwnerComponent();var C=c.getComponentModel();if(C.getProperty("/searchFlag")===false&&C.getProperty("/searchFlag")!==undefined){s.getToolbar().getAggregation("content")[2].setProperty("value","");this.oItemDistributionFilters={};}this.aitmDistFilt=[];var g=[];var O=this.itemKeys[0];var p=parseInt(this.itemKeys[1])+1;if(this.itemKeys.length>p+1){g=JSON.parse(this.itemKeys[p+1]);}if(O==="NE"){var e=new F({filters:[],and:true});for(var j=2;j<=p;j++){e.aFilters.push(new F("FormattedPurchaseContractItem","NE",this.itemKeys[j],true));}this.aitmDistFilt=new F(g,true);this.aitmDistFilt=this.aitmDistFilt.aFilters;this.aitmDistFilt.push(e);if(this.oItemDistributionFilters&&this.oItemDistributionFilters.length>0){this.aitmDistFilt.push(this.oItemDistributionFilters[0]);}}else if(O==="EQ"){for(var i=2;i<=p;i++){var b=this.itemKeys[i];var d=new sap.ui.model.Filter({path:"FormattedPurchaseContractItem",operator:O,value1:b});this.aitmDistFilt.push(d);}if(this.oItemDistributionFilters&&this.oItemDistributionFilters.length>0){var h=new F(this.oItemDistributionFilters,true);this.aitmDistFilt.push(h);}}else if(O==="X"){if(g.length>0){this.aitmDistFilt=new F(g,true);this.aitmDistFilt=this.aitmDistFilt.aFilters;}if(this.oItemDistributionFilters&&this.oItemDistributionFilters.length>0){this.aitmDistFilt.push(this.oItemDistributionFilters[0]);}}return this.aitmDistFilt;},onBeforeItemTableRebind:function(e){var t=this;this.deriveItemKeys();var b=e.getParameter("bindingParams");var s=b.sorter[0];b.filters=this.handleItemFilters();var d=this.getView().byId("HierItmDistMTable");var c=this.getView().byId("HierItmDistTable");this.aPGISorters=[];var v=this.getView();this.oBundleText=v.getModel("i18n").getResourceBundle();this.mGroupFunctions={FormattedPurchaseContractItem:function(C){var g=C.getProperty("FormattedPurchaseContractItem");var h=C.getProperty("CntrlPurContrFlxblDistrIsAllwd");var i=t.oBundleText.getText("FlexibleContracts");var j=t.oBundleText.getText("FormattedPurchaseContractItem");if(h){return{key:g,text:j+": "+g+" "+i};}else{return{key:g,text:j+": "+g};}}};if(!s){s=new sap.ui.model.Sorter("FormattedPurchaseContractItem",false,true);s.fnGroup=this.mGroupFunctions[s.sPath].bind(t);this.aPGISorters.push(s);b.sorter=b.sorter.concat(this.aPGISorters);b.sorter[2]=new sap.ui.model.Sorter("ReferenceHeaderDistributionKey",true,false);b.sorter[3]=new sap.ui.model.Sorter("PurgDocItemDistributionKey",false,false);}d.setVisible(false);c.setVisible(true);this.getView().byId("CancelBtn").setEnabled(false);this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(false);this.enableSimulationFeature();},deriveItemKeys:function(e){var c=this.getOwnerComponent();var C=c.getComponentModel();this.itemKeys=C.getProperty("/itemKeys");if(this.itemKeys!==undefined){this.itemKeys=this.itemKeys.replace(/#/g,"/");this.itemKeys=this.itemKeys.split("*");}},editHierItmDist:function(e){var d=[];if(this.getView().getModel("HierItemDistModel")!==undefined){this.getView().getModel("HierItemDistModel").setData({modelData:d});}var t=this;var v=this.getView();this.oBundleText=v.getModel("i18n").getResourceBundle();var p=this.getView().byId("HierItmDistTable");var D=this.getView().byId("HierItmDistMTable");var b=t.oBundleText.getText("HierItemDistribution")+" ("+p._getRowCount()+")";D.getExtension()[0].getAggregation("content")[0].getAggregation("content")[2].setEnabled(false);var s=p.getAggregation("items")[0].getAggregation("content")[2].getProperty("value");D.getExtension()[0].getAggregation("content")[0].getAggregation("content")[2].setValue(s);this.getView().byId("EditHierItmDistMtable").setEnabled(false);p.setVisible(false);D.setVisible(true);D.attachRowsUpdated(null,function(E){D.focus();});this.getView().byId("CancelBtn").setEnabled(true);var u="/C_CPurConHierItmDistrMassUpdt";var o=this.getOwnerComponent().getModel();sap.ui.core.BusyIndicator.show();o.read(u,{filters:this.aitmDistFilt,sorters:[new sap.ui.model.Sorter("FormattedPurchaseContractItem",false,false),new sap.ui.model.Sorter("ReferenceHeaderDistributionKey",true,false),new sap.ui.model.Sorter("PurgDocItemDistributionKey",false,false)],success:function(c){t.newData=t.addTotalRow(c);var i=new J();i.setData({modelData:t.newData});t.getView().setModel(i,"HierItemDistModel");t.mGroupFunctions={FormattedPurchaseContractItem:function(C){var j=C.getProperty("FormattedPurchaseContractItem");var k=C.getProperty("CntrlPurContrFlxblDistrIsAllwd");var l=t.oBundleText.getText("FlexibleContracts");var m=t.oBundleText.getText("FormattedPurchaseContractItem");if(k){return{key:j,text:m+": "+j+" "+l};}else{return{key:j,text:m+": "+j};}}};var S=new sap.ui.model.Sorter("FormattedPurchaseContractItem",false,true);var g=new sap.ui.model.Sorter("PurgDocItemDistributionKey",false,false);var h=new sap.ui.model.Sorter("ReferenceHeaderDistributionKey",true,false);S.fnGroup=t.mGroupFunctions[S.sPath].bind(t);D.getBinding("rows").sort([S,h,g]);D.getExtension()[0].getAggregation("content")[0].getAggregation("content")[0].setText(b);if(t.newData.length<10){D.setVisibleRowCountMode("Fixed");D.setVisibleRowCount(t.newData.length);}else{D.setVisibleRowCountMode("Auto");}sap.ui.core.BusyIndicator.hide();},error:function(E){sap.ui.core.BusyIndicator.hide();}});},onChange:function(e){var d=sap.ui.core.format.NumberFormat.getFloatInstance();var b=d.oFormatOptions.decimalSeparator;var c;var v=this.getView();this.oBundleText=v.getModel("i18n").getResourceBundle();c=e.getParameter("newValue");var g=c;var h;var t=0;var k=0;var r=/^[0-9]{0,3}(\,[0-9]{0,3})?$/;var l=/^[0-9]{0,3}(\.[0-9]{0,3})?$/;if(r.test(g)||l.test(g)){var C,m;c=c.replace(",",".");if(c!==""&&parseFloat(c)<=100){h=parseFloat(c).toFixed(3);this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(true);var T=this.getView().byId("HierItmDistMTable");var n=e.getSource().getParent().getParent().getParent().getIndex();if((b==="."&&g.indexOf(",")>0)||b==="."){this.newData[n].CntrlPurContrDistributionPct=h;}else if((b===","&&g.indexOf(".")>0)||b===","){this.newData[n].CntrlPurContrDistributionPct=h.replace(".",",");}var o=this.newData[n].FormattedPurchaseContractItem;C=this.newData[n].CentralPurchaseContract;m=this.newData[n].CentralPurchaseContractItem;var p=this.newData[n].PurgDocItemDistributionKey;var q=o+"*"+p;var s=parseFloat(c)-parseFloat(this.newData[n].CntrlPurContrItmDistrPct);this.newData[n].CntrlPurContrGRConsumptionPct=s;var u="/C_CPurConHierItmDistrMassUpdt(CentralPurchaseContract='"+C+"',CentralPurchaseContractItem='"+m+"',PurgDocItemDistributionKey='"+p+"')";T=this.getView().byId("HierItmDistMTable");var w=T.getModel().getProperty(u);T.getModel().setProperty(w.CntrlPurContrDistributionPct,"60",T.getModel().mContexts[u]);if(this.changedContract.indexOf(q)===-1){this.changedContract.push(q.replace("%20"," "));this.getView().byId("ApplyBtn").setEnabled(true);this.getView().byId("SimulateBtn").setEnabled(true);}else{this.getView().byId("ApplyBtn").setEnabled(true);this.getView().byId("SimulateBtn").setEnabled(true);if(parseFloat(c)===parseFloat(this.newData[n].CntrlPurContrItmDistrPct)){var x=this.changedContract.indexOf(q);this.changedContract.splice(x,1);}}for(var i=0;i<this.newData.length;i++){if(this.newData[i].hasOwnProperty("__metadata")===true){if(this.newData[i].FormattedPurchaseContractItem===o){break;}}}for(var j=i;j<this.newData.length;j++){if(this.newData[j].hasOwnProperty("__metadata")){var y;if(b===","){y=this.newData[j].CntrlPurContrDistributionPct.replace(".","");y=y.replace(",",".");}else{y=parseFloat(this.newData[j].CntrlPurContrDistributionPct).toFixed(3);}var z=y;if(isNaN(y)){this.newData[j].CntrlPurContrDistributionPct="";z=0;this.newData[j].CntrlPurContrGRConsumptionPct=0-this.newData[j].CntrlPurContrItmDistrPct;}t=t+parseFloat(z);k=k+parseFloat(this.newData[j].CntrlPurContrGRConsumptionPct);}else{break;}}t=parseFloat(t).toFixed(3);this.newData[j].CntrlPurContrDistributionPct=t;this.newData[j].CntrlPurContrGRConsumptionPct=k;for(var A=0;A<this.newData.length;A++){if(this.newData[A].hasOwnProperty("__metadata")===true){if(parseInt(this.newData[A].CntrlPurContrDistributionPct)===parseInt(this.newData[A].CntrlPurContrItmDistrPct)){this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(false);}else{this.getView().byId("ApplyBtn").setEnabled(true);this.getView().byId("SimulateBtn").setEnabled(true);this.getView().byId("ResetBtn").setEnabled(true);break;}}}if(this.getView().byId("ApplyBtn").getEnabled()===true||this.getView().byId("SimulateBtn").getEnabled()===true){for(A=0;A<this.newData.length;A++){if(this.newData[A].hasOwnProperty("__metadata")===false){if(isNaN(this.newData[A].CntrlPurContrDistributionPct)){this.newData[A].CntrlPurContrDistributionPct=0;}if((this.newData[A].CntrlPurContrFlxblDistrIsAllwd===false||this.newData[A].CntrlPurContrFlxblDistrIsAllwd==="")&&parseFloat(this.newData[A].CntrlPurContrDistributionPct)!==100){this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);break;}else{this.getView().byId("ApplyBtn").setEnabled(true);this.getView().byId("SimulateBtn").setEnabled(true);}}}}if(this.changedContract<1){this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);}if(!this.getView().byId("ResetBtn").getEnabled()){this.getView().byId("HierItmDistMTable").getModel().resetChanges();}}}else{this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(true);}var B=this.getView().byId("HierItmDistMTable").getBindingInfo("rows").binding.oList.length;for(var D=0;D<B;D++){if(this.getView().byId("HierItmDistMTable").getBindingInfo("rows").binding.oList[D].GroupHeaderReference!==1&&this.getView().byId("HierItmDistMTable").getBindingInfo("rows").binding.oList[D].ReferenceHeaderDistributionKey!==-1){if(this.getView().byId("HierItmDistMTable").getBindingInfo("rows").binding.oList[D].CntrlPurContrDistributionPct>100||this.getView().byId("HierItmDistMTable").getBindingInfo("rows").binding.oList[D].CntrlPurContrDistributionPct===""){this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);break;}}}},addTotalRow:function(d){var b;this.newData=[];var v=this.getView();this.oBundleText=v.getModel("i18n").getResourceBundle();var t=this;var n=t.oBundleText.getText("nonflexText");var c=d.results.length;var e=parseFloat(d.results[0].CntrlPurContrDistributionPct);var g=d.results[0].FormattedPurchaseContractItem;var h=d.results[0].CntrlPurContrFlxblDistrIsAllwd;var o=d.results[0].CntrlPurContrItmDistrPct;var j=d.results[0].CntrlPurContrGRConsumptionPct;var R=-1;var G=1;var k;if(d.results[0].CntrlPurContrFlxblDistrIsAllwd){k=g+" (Flexible Contract)";}else{k=g;}var l={FormattedPurchaseContractItem:g,GroupHeaderReference:G,CntrlPurContrDistributionPct:0,CntrlPurContrItmDistrPct:0,CntrlPurContrGRConsumptionPct:0,HeaderText:k};t.newData.push(l);t.newData[1]=d.results[0];t.newData[1].CntrlPurContrDistributionPct=t.formatter.fndecimalLocalized(t.newData[1].CntrlPurContrDistributionPct);var m;for(var i=1;i<c;i++){var p=d.results[i].FormattedPurchaseContractItem;var q=d.results[i].CntrlPurContrFlxblDistrIsAllwd;var r=d.results[i].CntrlPurContrItmDistrPct;var s=d.results[i].CntrlPurContrGRConsumptionPct;if(g===p){b=t.newData.push(d.results[i]);t.newData[b-1].CntrlPurContrDistributionPct=t.formatter.fndecimalLocalized(t.newData[b-1].CntrlPurContrDistributionPct);e=e+parseFloat(d.results[i].CntrlPurContrDistributionPct);}else{l={FormattedPurchaseContractItem:g,CntrlPurContrDistributionLevel:n,CntrlPurContrDistributionPct:parseFloat(e).toFixed(3),CntrlPurContrFlxblDistrIsAllwd:h,CntrlPurContrItmDistrPct:parseFloat(e).toFixed(3),CntrlPurContrGRConsumptionPct:j,ReferenceHeaderDistributionKey:R};m=t.newData.push(l);if(d.results[i].CntrlPurContrFlxblDistrIsAllwd){k=d.results[i].FormattedPurchaseContractItem+" (Flexible Contract)";}else{k=d.results[i].FormattedPurchaseContractItem;}l={FormattedPurchaseContractItem:d.results[i].FormattedPurchaseContractItem,GroupHeaderReference:G,CntrlPurContrDistributionPct:0,CntrlPurContrItmDistrPct:0,CntrlPurContrGRConsumptionPct:0,HeaderText:k};t.newData.push(l);b=t.newData.push(d.results[i]);t.newData[b-1].CntrlPurContrDistributionPct=t.formatter.fndecimalLocalized(t.newData[b-1].CntrlPurContrDistributionPct);g=p;h=q;o=r;j=s;e=parseFloat(d.results[i].CntrlPurContrDistributionPct);}}l={FormattedPurchaseContractItem:g,CntrlPurContrDistributionLevel:n,CntrlPurContrDistributionPct:parseFloat(e).toFixed(3),CntrlPurContrFlxblDistrIsAllwd:h,CntrlPurContrItmDistrPct:parseFloat(e).toFixed(3),CntrlPurContrGRConsumptionPct:j,ReferenceHeaderDistributionKey:R};m=t.newData.push(l);return t.newData;},onCancel:function(e){var d=[];this.getView().byId("HierItmDistMTable").getModel().resetChanges();var p=this.getView().byId("HierItmDistTable");var D=this.getView().byId("HierItmDistMTable");p.setVisible(true);D.setVisible(false);this.getView().byId("CancelBtn").setEnabled(false);this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(false);this.getView().getModel("HierItemDistModel").setData({modelData:d});},handlePopoverPress:function(e){var v=this.getView();this.oBundleText=v.getModel("i18n").getResourceBundle();var t=this;var p=t.oBundleText.getText("popOverNonFlexlessText");var b=t.oBundleText.getText("popOverNonflexSumGreaterText");var c=e.getSource().getParent().getParent().getAggregation("items")[2].getAggregation("items")[0].getText();var d=parseFloat(c);if(d>100){var g=b;}else{g=p;}var P=new sap.m.Popover({content:[new sap.m.Text({text:g}).addStyleClass("sapUiSmallMargin")]}).addStyleClass("sapUiMediumMargin");P.setShowHeader(false);P.openBy(e.getSource());},onReset:function(e){var d=sap.ui.core.format.NumberFormat.getFloatInstance();var b=d.oFormatOptions.decimalSeparator;this.getView().byId("HierItmDistMTable").getModel().resetChanges();this.getView().byId("ApplyBtn").setEnabled(false);this.getView().byId("SimulateBtn").setEnabled(false);this.getView().byId("ResetBtn").setEnabled(false);var t=this.getView().byId("HierItmDistMTable");var n=this.newData.length;for(var i=0;i<n;i++){if(b===","&&this.newData[i].hasOwnProperty("__metadata")){this.newData[i].CntrlPurContrDistributionPct=this.newData[i].CntrlPurContrItmDistrPct.replace(".",",");this.newData[i].CntrlPurContrGRConsumptionPct=parseFloat(0).toFixed(3);}else{this.newData[i].CntrlPurContrDistributionPct=this.newData[i].CntrlPurContrItmDistrPct;this.newData[i].CntrlPurContrGRConsumptionPct=parseFloat(0).toFixed(3);}}t.getModel("HierItemDistModel").refresh(true);},ApplyChange:function(e){var v=this.getView();var d;this.oBundleText=v.getModel("@i18n").getResourceBundle();if(!d){d=sap.ui.xmlfragment(v.getId(),"ui.s2p.mm.cntrl.ctrmass.update.HierItemDistribution.fragment.HierItemDistrApplyChangesDialog",this);var m=new J({buttonId:"ApplyBtn",dialogTitle:this.oBundleText.getText("applyChangesConfTitle"),Confirmation:this.oBundleText.getText("applyChangesConfirmation"),JobDescription:this.oBundleText.getText("massJobDescription"),CommentBox:this.oBundleText.getText("massChangeJobCommentBox"),Button:this.oBundleText.getText("applyChangesConfirmationApply")});this.getView().setModel(m,"dialog");v.addDependent(d);}this.getOwnerComponent().getModel().metadataLoaded().then(this.onMetadataLoadedOfApplyChangesDialog.bind(this,d));d.getContent()[1].getGroups()[0].getGroupElements()[1].setLabel(this.oBundleText.getText("PurchaserNote"));d.open();},Simulate:function(e){var v=this.getView();var d;this.oBundleText=v.getModel("@i18n").getResourceBundle();if(!d){d=sap.ui.xmlfragment(v.getId(),"ui.s2p.mm.cntrl.ctrmass.update.HierItemDistribution.fragment.HierItemDistrApplyChangesDialog",this);var m=new J({buttonId:"SimulateBtn",dialogTitle:this.oBundleText.getText("simulateConfTitle"),Confirmation:this.oBundleText.getText("simulateChangesConfirmation"),JobDescription:this.oBundleText.getText("simulateJobDescription"),CommentBox:this.oBundleText.getText("simulateJobCommentBox"),Button:this.oBundleText.getText("simulateJobConfirmationSimulate")});this.getView().setModel(m,"dialog");v.addDependent(d);}this.getOwnerComponent().getModel().metadataLoaded().then(this.onMetadataLoadedOfApplyChangesDialog.bind(this,d));d.getContent()[1].getGroups()[0].getGroupElements()[1].setLabel(this.oBundleText.getText("PurchaserNote"));d.open();},onJobDescriptionChange:function(e){if(e.getParameter("value")===""){this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(false);this.validationErrFields.push("JobDescription");}else{var V=this.validationErrFields.indexOf("JobDescription");if(V>-1){this.validationErrFields.splice(V,1);}if(this.validationErrFields.length<1){this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(true);}}},onMetadataLoadedOfApplyChangesDialog:function(s){var c=this.getOwnerComponent();var S=c.getModel();var m;if(s&&s.getId().indexOf("HierItmDistApplyChangesDialog")>-1){m=S.createEntry("/C_CPurConHierItmDistrMassUpdt",{groupId:"changes"});}s.setBindingContext(m);},validatePurchaserNote:function(e){if(e.getParameters().value.length>5000){e.getSource().setValueState("Error");e.getSource().setValueStateText(this.oBundleText.getText("PurchaserNoteMaxLength"));this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(false);var V=this.ValueStateErrorFields.indexOf("PurgDocNoteText");if(V<0){this.ValueStateErrorFields.push("PurgDocNoteText");}}else{e.getSource().setValueState("None");e.getSource().setValueStateText("");var V=this.validationErrFields.indexOf("PurgDocNoteText");if(V>-1){this.validationErrFields.splice(V,1);}if(this.validationErrFields.length<1){this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(true);}}},validateReasonCode:function(e){var n=e.getParameters().newValue;var v=this.getView().byId("CanvasItmPurchasingDocVersionReasonCode-comboBoxEdit").getValue();if(n===""&&v!==""){this.getView().byId("CanvasItmPurchasingDocVersionReasonCode").setValueState("Error");this.getView().byId("PurchasingDocVersionReasonCode").setValueStateText(this.oBundleText.getText("ReasonCodeErrText"));this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(false);this.validationErrFields.push("PurchasingDocVersionReasonCode");}else{this.getView().byId("CanvasItmPurchasingDocVersionReasonCode").setValueState("None");this.getView().byId("PurchasingDocVersionReasonCode").setValueStateText("");var V=this.validationErrFields.indexOf("PurchasingDocVersionReasonCode");if(V>-1){this.validationErrFields.splice(V,1);}if(this.validationErrFields.length<1){this.getView().byId("CanvasItmupdateJobConfirmationBtn").setEnabled(true);}}},onClickMassChangeJobs:function(e){var c=this.getOwnerComponent();var p={"JobCatalogEntryName":"SAP_MM_PUR_MASSCCTRBG_J"};var n=c.oExtensionAPI.getNavigationController();n.navigateExternal("CtrApplicationJob",p);},onPressCancelButton:function(){this.validationErrFields=[];var c=this.getOwnerComponent();var s=c.getModel();var C=this.getView().byId("HierItmDistApplyChangesDialog").getContent()[0].getBindingContext();s.deleteCreatedEntry(C);this.getView().byId("HierItmDistApplyChangesDialog").close();this.getView().byId("HierItmDistApplyChangesDialog").destroy();},onSubmitChnges:function(e){sap.ui.core.BusyIndicator.show(5);var d=sap.ui.core.format.NumberFormat.getFloatInstance();var b=d.oFormatOptions.decimalSeparator;var R=this.getView().byId("CanvasItmPurchasingDocVersionReasonCode").getValue();var P=this.getView().byId("CanvasItmPurgDocNoteText").getValue();var c=this.getView().byId("HierItmDistApplyChangesDialogmassChangeJobCommentBox").getValue();this.getView().byId("HierItmDistMTable").getModel().resetChanges();this.onPressCancelButton();this.updateContracts=[];var t=this;this.newModel=[];for(var i=0;i<this.newData.length;i++){if(this.newData[i].hasOwnProperty("__metadata")===true){var g=this.newData[i].FormattedPurchaseContractItem+"*"+this.newData[i].PurgDocItemDistributionKey;if(this.changedContract.indexOf(g)!==-1){this.updateContracts.push(this.newData[i]);}}}var m=this.getView().getModel();m.setDeferredGroups(["DEFAULT"]);var h=this.getView().getModel("dialog").getData().buttonId;if(h==="SimulateBtn"){m.setHeaders({"MassAddition":"","Simulation":"X"});}else{m.setHeaders({"MassAddition":"","Simulation":""});}var j=this.updateContracts;if(b===","){for(var k=0;k<j.length;k++){j[k].CntrlPurContrDistributionPct=j[k].CntrlPurContrDistributionPct.replace(",",".");}}this.changedContract=[];var l={};var n=[];k=0;$.each(j,function(){l[k]={CentralPurchaseContract:this.ActivePurchasingDocument,CentralPurchaseContractItem:this.CentralPurchaseContractItem,PurgDocItemDistributionKey:this.PurgDocItemDistributionKey,CntrlPurContrDistributionPct:this.CntrlPurContrDistributionPct,InternalComment:c};if(R){l[k].PurchasingDocVersionReasonCode=R;}if(P){l[k].PurgDocNoteText=P;}n.push(l[k]);k++;});for(i=0;i<this.updateContracts.length;i++){var r=n[i];var u=this.updateContracts[i].__metadata.id;var o=u.search("/C_CPurConHierItmDistrMassUpdt");var p=u.substring(o);m.update(p,r,{groupId:"DEFAULT",changeSetId:"myId"});}m.submitChanges({groupId:"DEFAULT",success:function(q){var s,v,w,x;if(q&&q.__batchResponses&&q.__batchResponses[0]&&q.__batchResponses[0].__changeResponses&&q.__batchResponses[0].__changeResponses[0]&&q.__batchResponses[0].__changeResponses[0].headers&&q.__batchResponses[0].__changeResponses[0].headers.hasOwnProperty("sap-message")){var y=JSON.parse(q.__batchResponses[0].__changeResponses[0].headers["sap-message"]);if(y.severity==="success"){v=JSON.parse(q.__batchResponses[0].__changeResponses[0].headers["sap-message"]).message.split(" ")[1];}}if(v!==undefined&&v!==null){w=t.oBundleText.getText("jobDescription",[c]);x=t.oBundleText.getText("jobCreatedText",[c]);s=new sap.m.Text("sJobScheduledText",{text:x.replace(w,'"'+w+'"')});var z=new sap.m.Dialog({title:t.oBundleText.getText("success"),type:"Message",state:"Success",content:s,beginButton:new sap.m.Button({text:t.oBundleText.getText("viewJobButtonText"),press:function(){t.onClickMassChangeJobs(v);z.close();}}),endButton:new sap.m.Button({text:t.oBundleText.getText("closeButtonText"),press:function(){z.close();z.getParent().byId("HierItmDistMTable").setVisible(false);z.getParent().byId("HierItmDistTable").setVisible(true);z.getParent().byId("ApplyBtn").setEnabled(false);z.getParent().byId("SimulateBtn").setEnabled(false);z.getParent().byId("CancelBtn").setEnabled(false);z.getParent().byId("ResetBtn").setEnabled(false);z.getParent().byId("HierItmDistTable").getModel().refresh();}}),afterClose:function(){z.destroy();}});t.getView().addDependent(z);sap.ui.core.BusyIndicator.hide();z.open();}else{t.getView().byId("HierItmDistMTable").setVisible(false);t.getView().byId("HierItmDistTable").setVisible(true);t.getView().byId("ApplyBtn").setEnabled(false);t.getView().byId("SimulateBtn").setEnabled(false);t.getView().byId("CancelBtn").setEnabled(false);t.getView().byId("ResetBtn").setEnabled(false);t.getView().byId("HierItmDistTable").getModel().refresh();s=t.oBundleText.getText("jobFailedText");sap.ui.core.BusyIndicator.hide();M.error(s);}},error:function(q){t.getView().byId("HierItmDistMTable").setVisible(false);t.getView().byId("HierItmDistTable").setVisible(true);t.getView().byId("ApplyBtn").setEnabled(false);t.getView().byId("SimulateBtn").setEnabled(false);t.getView().byId("CancelBtn").setEnabled(false);t.getView().byId("ResetBtn").setEnabled(false);t.getView().byId("HierItmDistTable").getModel().refresh();var s=t.oBundleText.getText("errorOccured");sap.ui.core.BusyIndicator.hide();M.error(s);}});}});});
