/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MessageBox","sap/m/UploadCollectionParameter"],function(M,U){"use strict";var E={appliedFilter:undefined,isFilterSet:undefined,isInclExclSet:undefined,isSimulate:undefined,uploadedFileName:"",fnDownloadButtonEnableDisable:function(e){this.ExcelDataCount=0;if(e.getParameters().url.indexOf("C_PurCntrlContrMassUpdt/$count")>=0){this.appliedFilter=this.getView().byId("listReportFilter").getFilters();if(e.getParameters().response&&e.getParameters().response.responseText&&e.getParameters().response.responseText!=="0"){this.ExcelDataCount=parseInt(e.getParameters().response.responseText,10);}if(this.ExcelDataCount>0){this.getView().byId("ui.s2p.mm.cntrl.ctrmass.update::sap.suite.ui.generic.template.ListReport.view.ListReport::C_PurCntrlContrItmMassUpdt--action::ActionExcelDownload").setEnabled(true);sap.ui.getCore().byId("downloadBtn").setEnabled(true);sap.ui.getCore().byId("downloadCctrBtn").setEnabled(true);sap.ui.getCore().byId("downloadHctrBtn").setEnabled(true);}else{this.getView().byId("ui.s2p.mm.cntrl.ctrmass.update::sap.suite.ui.generic.template.ListReport.view.ListReport::C_PurCntrlContrItmMassUpdt--action::ActionExcelDownload").setEnabled(false);sap.ui.getCore().byId("downloadBtn").setEnabled(false);sap.ui.getCore().byId("downloadCctrBtn").setEnabled(false);sap.ui.getCore().byId("downloadHctrBtn").setEnabled(false);}}else if(e.getParameters().url.indexOf("C_CntrlPurContrHierMassUpdt/$count")>=0){this.appliedFilter=this.getView().byId("listReportFilter").getFilters();if(e.getParameters().response&&e.getParameters().response.responseText&&e.getParameters().response.responseText!=="0"){this.ExcelDataCount=parseInt(e.getParameters().response.responseText,10);}if(this.ExcelDataCount>0){sap.ui.getCore().byId("downloadBtn").setEnabled(true);sap.ui.getCore().byId("downloadHctrBtn").setEnabled(true);}else{sap.ui.getCore().byId("downloadHctrBtn").setEnabled(false);}}},OnClickExcelDownload:function(){var t=this;var u="/C_PurCntrlContrItmMassUpdt";var p="/PurCntrlContrDownloadExcelSet(ExcelName='MCCPC_Excel.xlsx')";var a={},b={},e={},f;a=t._preparePayloadAsPerScenario(a,"ME");b={sPath:"PurchasingDocInclusionList",sOperator:"EQ",oValue1:a.PurchasingDocInclusionList};e={sPath:"PurchasingDocExclusionList",sOperator:"EQ",oValue1:a.PurchasingDocExclusionList};f=JSON.parse(JSON.stringify(this.appliedFilter));if(b.oValue1!==undefined){f.push(b);}if(e.oValue1!==undefined){f.push(e);}this.getView().getModel().setHeaders({"DownloadExcel":"X"});this.isFilterSet=true;this.getOwnerComponent().getModel().read(u,{groupId:"Changes",filters:f,urlParameters:{"$top":"1"}});this.getOwnerComponent().getModel().read(p,{groupId:"Changes"});sap.ui.core.BusyIndicator.show();this.getOwnerComponent().getModel().submitChanges({groupId:"Changes",success:function(o,r){var c;if(t.isFilterSet){c=1;}else{c=0;}if(r&&r.data&&r.data.__batchResponses[c]&&r.data.__batchResponses[c].data&&r.data.__batchResponses[c].data.ExcelName&&r.data.__batchResponses[c].data.ExcelName!=="#"){var d=r.data.__batchResponses[c].data.ExcelName;var g=atob(r.data.__batchResponses[c].data.ExcelContent);var h=new Array(g.length);for(var i=0;i<g.length;i++){h[i]=g.charCodeAt(i);}var j=new Uint8Array(h);var k=new Blob([j],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});if(sap.ui.Device.browser.msie){window.navigator.msSaveOrOpenBlob(k,d);sap.ui.core.BusyIndicator.hide();t.getView().getModel().setHeaders({"DownloadExcel":""});}else{var T=window.document.createElement("a");var l=window.URL.createObjectURL(k);T.href=l;T.download=d;T.click();sap.ui.core.BusyIndicator.hide();t.getView().getModel().setHeaders({"DownloadExcel":""});}}else{var m=t.oBundleText.getText("downloadErrMsg");t.getView().getModel().setHeaders({"DownloadExcel":""});if(r&&r.data&&r.data.__batchResponses[c]&&r.data.__batchResponses[c].headers&&r.data.__batchResponses[c].headers["sap-message"]){var n=r.data.__batchResponses[c].headers["sap-message"];var q=JSON.parse(n);if(q.code==="EXL_OPS/000"){m=q.message;m=m+t.oBundleText.getText("configurationErrorMsg");}else if(q.code==="EXL_OPS/004"){m=q.message;m=m+t.oBundleText.getText("configurationErrorMsg");}}sap.ui.core.BusyIndicator.hide();M.error(m);}t.isTabChanged=false;t.resetTables(t);t.filtersWithInclExcl=[];},error:function(c){t.getView().getModel().setHeaders({"DownloadExcel":""});var m=t.oBundleText.getText("errorOccured");sap.ui.core.BusyIndicator.hide();M.error(m);}});},OnClickHctrExcelDownload:function(){var t=this;var u="/C_CntrlPurContrHierItmMassUpdt";var p="/PurCntrlContrDownloadExcelSet(ExcelName='MCCPC_Excel.xlsx')";var a={},b={},e={},f;a=t._preparePayloadAsPerScenario(a,"HME");b={sPath:"PurchasingDocInclusionList",sOperator:"EQ",oValue1:a.PurchasingDocInclusionList};e={sPath:"PurchasingDocExclusionList",sOperator:"EQ",oValue1:a.PurchasingDocExclusionList};f=JSON.parse(JSON.stringify(this.appliedFilter));if(b.oValue1!==undefined){f.push(b);}if(e.oValue1!==undefined){f.push(e);}this.getView().getModel().setHeaders({"DownloadExcel":"X"});this.isFilterSet=true;this.getOwnerComponent().getModel().read(u,{groupId:"Changes",filters:f,urlParameters:{"$top":"1"}});this.getOwnerComponent().getModel().read(p,{groupId:"Changes"});sap.ui.core.BusyIndicator.show();this.getOwnerComponent().getModel().submitChanges({groupId:"Changes",success:function(o,r){var c;if(t.isFilterSet){c=1;}else{c=0;}if(r&&r.data&&r.data.__batchResponses[c]&&r.data.__batchResponses[c].data&&r.data.__batchResponses[c].data.ExcelName&&r.data.__batchResponses[c].data.ExcelName!=="#"){var d=r.data.__batchResponses[c].data.ExcelName;var g=atob(r.data.__batchResponses[c].data.ExcelContent);var h=new Array(g.length);for(var i=0;i<g.length;i++){h[i]=g.charCodeAt(i);}var j=new Uint8Array(h);var k=new Blob([j],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});if(sap.ui.Device.browser.msie){window.navigator.msSaveOrOpenBlob(k,d);sap.ui.core.BusyIndicator.hide();t.getView().getModel().setHeaders({"DownloadExcel":""});}else{var T=window.document.createElement("a");var l=window.URL.createObjectURL(k);T.href=l;T.download=d;T.click();sap.ui.core.BusyIndicator.hide();t.getView().getModel().setHeaders({"DownloadExcel":""});}}else{var m=t.oBundleText.getText("downloadHCTRErrMsg");t.getView().getModel().setHeaders({"DownloadExcel":""});if(r&&r.data&&r.data.__batchResponses[c]&&r.data.__batchResponses[c].headers&&r.data.__batchResponses[c].headers["sap-message"]){var n=r.data.__batchResponses[c].headers["sap-message"];var q=JSON.parse(n);if(q.code==="EXL_OPS/000"){m=q.message;m=m+t.oBundleText.getText("configurationErrorMsg");}}sap.ui.core.BusyIndicator.hide();M.error(m);}t.isTabChanged=false;t.resetTables(t);t.filtersWithInclExcl=[];},error:function(c){t.getView().getModel().setHeaders({"DownloadExcel":""});var m=t.oBundleText.getText("errorOccured");sap.ui.core.BusyIndicator.hide();M.error(m);}});},fnChangeUploadFiles:function(e){var t=this;var f=e.getParameters().files[0].size;if(f>0){var a=this.oBundleText.getText("UploadExcel");var u=this.oBundleText.getText("uploadJobDescription");var b=e.getParameters().files[0].name;var d=this.oBundleText.getText("defaultJobDescUpload",[b]);var c=new sap.m.Dialog({title:a,type:"Message",content:[new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text("excelConfirmationDialogText",{text:u}),new sap.m.TextArea("excelConfirmDialogTextarea",{ariaLabelledBy:"excelConfirmationDialogText",width:"100%",value:d,maxLength:100})]})],beginButton:new sap.m.Button("UploadExcBtn",{text:t.oBundleText.getText("ActionExcelUpload"),press:function(){var C=sap.ui.getCore().byId("excelConfirmDialogTextarea").getValue();t.sComment=C;c.close();t.getView().byId("fileUploader").upload();},type:"Emphasized"}),endButton:new sap.m.Button({text:t.oBundleText.getText("cancelButtonText"),press:function(){c.close();}}),afterClose:function(){c.destroy();}});if(sap.ui.getCore().byId("excelConfirmDialogTextarea")){sap.ui.getCore().byId("excelConfirmDialogTextarea").attachLiveChange(this.ExcelOperations.fnEnableDisableUpldBtn.bind(this));}c.open();}},fnChangeUploadFilesV2:function(e){var t=this;var f=e.getParameters().files[0].size;var r=this.getView().getModel("@i18n").getResourceBundle();if(f>0){sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(true);sap.ui.getCore().byId("uploadExcel--SimulateBtn").setEnabled(true);var F=e.getParameters().files[0].name;this.uploadedFileName=F;}setTimeout(function(){t.ExcelOperations._attachFileDelPress(r,F);},0);},fnOpenExcelUploadModel:function(e){var t=this,f="ui.s2p.mm.cntrl.ctrmass.update.ext.fragment.ExcelPopup",v=this.getView();if(!t._oDialogObjList){t._oDialogObjList=sap.ui.xmlfragment("uploadExcel",f,t);v.addDependent(t._oDialogObjList);}t.oModel=v.getModel();t._oDialogObjList.setModel(t.oModel);t.ExcelOperations._resetUploadCollection();sap.ui.getCore().byId("uploadExcel--excelUploadFrag").setTitle(this.excelUploadTypeText);t._oDialogObjList.open();},_resetUploadCollection:function(){var u=sap.ui.getCore().byId("uploadExcel--UploadCollection");if(u.getItems().length>0){u.removeAllItems();}setTimeout(function(){if(u&&u.getToolbar()){var c=u.getToolbar()._getControlsIds()[2];sap.ui.getCore().byId(c).setEnabled(true);}},0);sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(false);sap.ui.getCore().byId("uploadExcel--SimulateBtn").setEnabled(false);},_attachFileDelPress:function(r,f){var u=sap.ui.getCore().byId("uploadExcel--UploadCollection");var i=u.getItems(),c=u.getToolbar()._getControlsIds()[2],m=r.getText("deleteExcelConfirmMsg",f);i=i[0];sap.ui.getCore().byId(c).setEnabled(false);i.attachDeletePress(function(e){M.show(m,{title:r.getText("deleteExcelConfirmTitle"),actions:[r.getText("deleteExcelConfirmOkBtn"),sap.m.MessageBox.Action.CANCEL],onClose:function(a){if(a===r.getText("deleteExcelConfirmOkBtn")){u.removeAllItems();sap.ui.getCore().byId(c).setEnabled(true);sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(false);sap.ui.getCore().byId("uploadExcel--SimulateBtn").setEnabled(false);this._objErrUploadVal={};}else{sap.ui.getCore().byId(c).setEnabled(false);sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(true);}}});});},fnEnableDisableUpldBtn:function(){var j=sap.ui.getCore().byId("excelConfirmDialogTextarea").getValue();if(j&&j.length>0){sap.ui.getCore().byId("UploadExcBtn").setEnabled(true);}else{sap.ui.getCore().byId("UploadExcBtn").setEnabled(false);}},fnEnableDisableSimBtn:function(){var j=sap.ui.getCore().byId("excelConfirmDialogTextarea").getValue();if(j&&j.length>0){sap.ui.getCore().byId("SimulateExcBtn").setEnabled(true);}else{sap.ui.getCore().byId("SimulateExcBtn").setEnabled(false);}},fnBeforeUpload:function(e){sap.ui.core.BusyIndicator.show();var u=e.getParameters().fileName;var c=this.getView().getModel().getSecurityToken();e.getParameters().requestHeaders.push({name:"x-csrf-token",value:c});e.getParameters().requestHeaders.push({name:"slug",value:u+"#"+this.sComment});},fnBeforeUploadV2:function(e){sap.ui.core.BusyIndicator.show();var u=e.getParameters().fileName;var c=this.getView().getModel().getSecurityToken();var C=new U({name:"x-csrf-token",value:c});e.getParameters().addHeaderParameter(C);if(this.isSimulate==="X"){var o=new U({name:"slug",value:u+"#"+this.sComment+"#"+this.excelUploadType+"#"+this.isSimulate});}else{o=new U({name:"slug",value:u+"#"+this.sComment+"#"+this.excelUploadType});}e.getParameters().addHeaderParameter(o);},fnUploadComplete:function(e){sap.ui.core.BusyIndicator.hide();var t=this;var b=this.getView().getModel("@i18n").getResourceBundle();if(e.getParameters().status===200||e.getParameters().status===201){var r=e.getParameters().responseRaw;var J=this.ExcelOperations.getJobIdFromXMLResp(r);sap.ui.core.BusyIndicator.hide();if(J&&J.length>1){var j=b.getText("jobDescription",[t.sComment]);var s=b.getText("jobCreatedText",[t.sComment]);var d=new sap.m.Dialog({title:"success",type:"Message",state:"Success",content:[new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text("confirmDialogText",{text:s.replace(j,'"'+j+'"')})]})],beginButton:new sap.m.Button({text:b.getText("viewJobButtonText"),press:function(){t.onClickMassChangeJobs();d.close();}}),endButton:new sap.m.Button({text:b.getText("closeButtonText"),press:function(){d.close();}}),afterClose:function(){d.destroy();}});t.getView().addDependent(d);d.open();}else{if(e.getParameters().headers&&e.getParameters().headers["sap-message"]){var m=e.getParameters().headers["sap-message"];var a=t.ExcelOperations.getErrorMsgFromXMLResp(m);if(a&&a.length>1){M.error(a);sap.ui.core.BusyIndicator.hide();}else{M.error(b.getText("errorOccured"));sap.ui.core.BusyIndicator.hide();}}}}else{sap.ui.core.BusyIndicator.hide();M.error(b.getText("errorOccured"));}},fnUploadCompleteV2:function(e){sap.ui.core.BusyIndicator.hide();var t=this;var b=this.getView().getModel("@i18n").getResourceBundle();if(e.getParameters().getParameters().status===200||e.getParameters().getParameters().status===201){var r=e.getParameters().getParameters().responseRaw;var J=this.ExcelOperations.getJobIdFromXMLResp(r);sap.ui.core.BusyIndicator.hide();if(J&&J.length>1){var j=b.getText("jobDescription",[t.sComment]);var s=b.getText("jobCreatedText",[t.sComment]);var d=new sap.m.Dialog({title:"Success",type:"Message",state:"Success",content:[new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text("confirmDialogText",{text:s.replace(j,'"'+j+'"')})]})],beginButton:new sap.m.Button({text:b.getText("viewJobButtonText"),press:function(){t.onClickMassChangeJobs();d.close();}}),endButton:new sap.m.Button({text:b.getText("closeButtonText"),press:function(){d.close();t.ExcelOperations.closeUploadDialog();}}),afterClose:function(){d.destroy();}});t.getView().addDependent(d);d.open();}else{if(e.getParameters().headers&&e.getParameters().headers["sap-message"]){var m=e.getParameters().headers["sap-message"];var a=t.ExcelOperations.getErrorMsgFromXMLResp(m);if(a&&a.length>1){M.error(a);sap.ui.core.BusyIndicator.hide();}else{M.error(b.getText("errorOccured"));sap.ui.core.BusyIndicator.hide();}}}}else{sap.ui.core.BusyIndicator.hide();M.error(b.getText("errorOccured"));}sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(false);sap.ui.getCore().byId("uploadExcel--SimulateBtn").setEnabled(false);var u=sap.ui.getCore().byId("uploadExcel--UploadCollection");var c=u.getToolbar()._getControlsIds()[2];sap.ui.getCore().byId(c).setEnabled(true);},getJobIdFromXMLResp:function(r){var p=new DOMParser();var j=p.parseFromString(r,"text/xml");if(j.getElementsByTagName("d:JobName")&&j.getElementsByTagName("d:JobName")[0]&&j.getElementsByTagName("d:JobName")[0].childNodes&&j.getElementsByTagName("d:JobName")[0].childNodes[0]&&j.getElementsByTagName("d:JobName")[0].childNodes[0].nodeValue){var a=j.getElementsByTagName("d:JobName")[0].childNodes[0].nodeValue;}return a;},getErrorMsgFromXMLResp:function(r){var p=new DOMParser();var e=p.parseFromString(r,"text/xml");if(e.getElementsByTagName("message")&&e.getElementsByTagName("message")[0]&&e.getElementsByTagName("message")[0].childNodes&&e.getElementsByTagName("message")[0].childNodes[0]&&e.getElementsByTagName("message")[0].childNodes[0].nodeValue){var a=e.getElementsByTagName("message")[0].childNodes[0].nodeValue;}return a;},fnFileTypeMissmatch:function(){var m=new sap.m.Text("sFileTypeMisMatch",{text:this.oBundleText.getText("ExcelUploadTypeMismatch")});var d=new sap.m.Dialog({title:this.oBundleText.getText("Error"),type:"Message",state:"Error",content:m,endButton:new sap.m.Button({text:this.oBundleText.getText("closeButtonText"),press:function(){d.close();}}),afterClose:function(){d.destroy();}});d.open();},onUploadBtnClick:function(e){var t=this;var d;var u;var S;var o=sap.ui.getCore().byId("uploadExcel--UploadCollection");if(o.getItems().length>1){var m=t.oBundleText.getText("uploadErrorMsg");M.error(m);}else{if(e.getSource().getId()==="uploadExcel--uploadBtn"){this.isSimulate="";var a=this.oBundleText.getText("UploadExcel");u=this.oBundleText.getText("uploadJobDescription");if(this.excelUploadType==="EXL_OPS_CCTR"){d=this.oBundleText.getText("defaultJobDescUpd",[this.uploadedFileName]);}else if(this.excelUploadType==="EXL_OPS_HCTR"){d=this.oBundleText.getText("defaultJobDescHier",[this.uploadedFileName]);}var b=new sap.m.Dialog({title:a,type:"Message",content:[new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text("excelConfirmationDialogText",{text:u}),new sap.m.TextArea("excelConfirmDialogTextarea",{ariaLabelledBy:"excelConfirmationDialogText",width:"100%",value:d,maxLength:100})]})],beginButton:new sap.m.Button("UploadExcBtn",{text:t.oBundleText.getText("ActionExcelUpload"),press:function(){var C=sap.ui.getCore().byId("excelConfirmDialogTextarea").getValue();t.sComment=C;b.close();o.upload();},type:"Emphasized"}),endButton:new sap.m.Button({text:t.oBundleText.getText("cancelButtonText"),press:function(){b.close();}}),afterClose:function(){b.destroy();}});if(sap.ui.getCore().byId("excelConfirmDialogTextarea")){sap.ui.getCore().byId("excelConfirmDialogTextarea").attachLiveChange(this.ExcelOperations.fnEnableDisableUpldBtn.bind(this));}b.open();}else if(e.getSource().getId()==="uploadExcel--SimulateBtn"){this.isSimulate="X";var c=this.oBundleText.getText("SimulateJob");u=this.oBundleText.getText("uploadJobDescription");if(this.excelUploadType==="EXL_OPS_CCTR"){S=this.oBundleText.getText("defSimJobDescUpload",[this.uploadedFileName]);}else if(this.excelUploadType==="EXL_OPS_HCTR"){S=this.oBundleText.getText("SimJobDescUploadHCTR",[this.uploadedFileName]);}var f=new sap.m.Dialog({title:c,type:"Message",content:[new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text("excelConfirmationDialogText",{text:u}),new sap.m.TextArea("excelConfirmDialogTextarea",{ariaLabelledBy:"excelConfirmationDialogText",width:"100%",value:S,maxLength:120})]})],beginButton:new sap.m.Button("SimulateExcBtn",{text:t.oBundleText.getText("ActionExcelSimulate"),press:function(){var C=sap.ui.getCore().byId("excelConfirmDialogTextarea").getValue();t.sComment=C;f.close();o.upload();},type:"Emphasized"}),endButton:new sap.m.Button({text:t.oBundleText.getText("cancelButtonText"),press:function(){f.close();}}),afterClose:function(){f.destroy();}});if(sap.ui.getCore().byId("excelConfirmDialogTextarea")){sap.ui.getCore().byId("excelConfirmDialogTextarea").attachLiveChange(this.ExcelOperations.fnEnableDisableSimBtn.bind(this));}f.open();}}},fnEmptyFileSelected:function(e){var m=new sap.m.Text("sFileSizeZero",{text:this.oBundleText.getText("FileSizeZero")});var d=new sap.m.Dialog({title:this.oBundleText.getText("Error"),type:"Message",state:"Error",content:m,endButton:new sap.m.Button({text:this.oBundleText.getText("closeButtonText"),press:function(){d.close();}}),afterClose:function(){d.destroy();}});d.open();},closeUploadDialog:function(){var d=sap.ui.core.Fragment.byId("uploadExcel","excelUploadFrag");sap.ui.getCore().byId("uploadExcel--uploadBtn").setEnabled(false);if(d){d.close();}}};return E;});
